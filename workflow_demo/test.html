<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Wikispeech workflow demo</title>
  <meta name="description" content="Edit, synthesise, listen loop">

  <!-- jquery css for columns -->
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css">

  <!-- responsivetabs -->
  <link rel="stylesheet" href="ext/responsivetabs/css/font-awesome.css">
  <link rel="stylesheet" href="ext/responsivetabs/css/style.css">

  <!-- Trumbowyg editor -->
<!--  <link rel="stylesheet" href="ext/Trumbowyg-master/css/main.css">-->
  <link rel="stylesheet" href="ext/Trumbowyg-master/dist/ui/trumbowyg.css">

<script type="text/javascript" src="../wikispeech_simple_player.js"></script>
<script type="text/javascript">
window.onload = function() {
 ws_host = "http://localhost:10000/wikispeech";
};
</script>


</head>


<body>
  <h1></h1>
  <main>

    <div id="tabs" class="c-tabs no-js">
      <div class="c-tabs-nav">
	<a href="#" class="c-tabs-nav__link is-active"><span>Input</span></a>
	<a href="#" class="c-tabs-nav__link"><span>Synthesis</span></a>
	<a href="#" class="c-tabs-nav__link"><span>Lexicon</span></a>    
	<a href="#" class="c-tabs-nav__link"><span>Lexicon Entry Editor</span></a>    
      </div>
  
      <div class="c-tab is-active">
	<div class="c-tab__content">
	  <h2>Input</h2>
	  <p>Edit html here, then synthesise or lookup words.</p>
	  <input type="button" onclick="tokeniseHtmlText();" value="Tokenise"></input>
	  
	  <div id="html_editor">

	    <!-- some sample text to start with, remove after testing! -->
	    <p><br>
	      <ssml:s>
	      Fartyget byggdes <br>
	      <ssml:sub alias="nittonhundra-femtionio">1959</ssml:sub> 
	      i 
	      <phoneme alphabet="x-sampa" ph="' p O - rt u0 - g a l">Portugal</phoneme> 
	      på 
	      <phoneme alphabet="x-sampa" ph="e s - t a - ' l e j - r O s">Estaleiros</phoneme> 
	      <phoneme alphabet="x-sampa" ph="n a - ' v a j s">Navais</phoneme> 
	      <phoneme alphabet="x-sampa" ph="' d e">de</phoneme> 
	      <phoneme alphabet="x-sampa" ph="v I - ' a - n a">Viana</phoneme> 
	      <phoneme alphabet="x-sampa" ph="' d O">do</phoneme> 
	      <phoneme alphabet="x-sampa" ph="k a s - ' t e - l O">Castelo</phoneme>
	      , och levererades till Färöarna under namnet 
	      <phoneme alphabet="x-sampa" ph="' v A: k - b I N - k u0 r">Vágbingur</phoneme>
	      .
	      </ssml:s>
	      <ssml:s>
	      Under 20 års tid tjänstgjorde det som fiskefartyg på 
	      <ssml:sub alias="nord-atlanten">nordatlanten</ssml:sub> 
	      innan fartyget 
	      <ssml:sub alias="nittonhundra-åttioett">1981</ssml:sub> 
	      såldes till Göteborg, då i namnet 
	      <phoneme alphabet="x-sampa" ph="&quot; b j A: rn - % 2 j">Bjarnoy</phoneme> 
	      <ssml:sub alias="två">II</ssml:sub>
	      .
	      </ssml:s>
	    </p>
	    <!-- end of sample text -->

          </div>


	</div>	
      </div>
      
      <div class="c-tab">
	<div class="c-tab__content">
	  <h2>Synthesis</h2>

	  <div id="synthesis_container">

	    <!-- Initial content for testing -->
	    <div>
	      <span contenteditable>Fartyget byggdes 1959 i Portugal på Estaleiros Navais de Viana do Castelo , och levererades till Färöarna under namnet Vágbingur.</span>
	      <audio controls></audio>
	      <input type="button" value="Synthesise"></input>
	    </div>
	    
	    <div>
	      <span>Under 20 års tid tjänstgjorde det som fiskefartyg på nordatlanten innan fartyget 1981 såldes till Göteborg, då i namnet Bjarnoy II .</span>
	      <audio controls></audio>
	      <input type="button" value="Synthesise">
	    </div>
	    <!-- END Initial content for testing -->

	  </div>
	</div>
      </div>
      
      <div class="c-tab">
	<div class="c-tab__content">
	  <h2>Lexicon</h2>

	  <div data-role="main" class="ui-content">
	    <div class="ui-grid-a">
	      <div class="ui-block-a">
		<h3>Known words</h3>
		<div id="known_words_container">
		  <!--
		  <a href="#" class="ui-btn ui-corner-all ui-shadow">First Column Button</a><br>
		  <span>First Column: This is some text. This is some text. This is some text. This is some text. This is some text.</span>
		  -->
		  <!-- Initial content for testing -->
		  <div>
		    <span id="word1" style="display: inline-block; width: 10em;">Fartyget</span>
		    <span>
		      <input type="button" value="Listen">
		      <input type="button" value="Edit" onclick="myTabs.goToTab(3);searchLexicon($('#word1')[0].innerHTML);">
		    </span>
		  </div>
		  
		  <div>
		    <span id="word2">byggdes</span>
		    <input type="button" value="Listen">
		    <input type="button" value="Edit" onclick="myTabs.goToTab(3);searchLexicon($('#word2')[0].innerHTML);">
		  </div>
		</div>
	      </div>
	      
	      <div class="ui-block-b">
		<h3>Unknown words</h3>
		<div id="unknown_words_container">
		  <!--
		  <a href="#" class="ui-btn ui-corner-all ui-shadow">Second Column Button</a><br>
		  <span>Second Column: This is some text. This is some text. This is some text. This is some text.</span>
		  -->
		  <!-- Initial content for testing -->	    
		  <div>
		    <span id="word3">1959</span>
		    <input type="button" value="Listen">
		    <input type="button" value="Edit" onclick="myTabs.goToTab(3);searchLexicon($('#word3')[0].innerHTML);">
		  </div>
		  <!-- END Initial content for testing -->
		  
		</div>
	      </div>
	    </div>
	    
	    <div id="lexicon_container">



	    </div>
	  </div>
	</div>
      </div>
      <div class="c-tab">
	<div class="c-tab__content">
	  <h2>Lexicon entry editor</h2>
	  <p>
	    The lexicon entry editor displays editable and uneditable information for the lexicon entry. Uses json schema. Validation of fields. 
	  </p>
	  <div>
	    <input type="text" id="search_term">
	    <input type="button" value="search" onclick="searchLexicon($('#search_term').val());">
	  </div>
	  <hr/>
    
	  <div id="entry_editor_holder"></div>


	</div>
      </div>


    </div>
    
  </main>
  <hr>
  <address></address>
  <!-- hhmts start -->Last modified: Mon Sep  5 14:13:52 CEST 2016 <!-- hhmts end -->
  
  <script src="ext/responsivetabs/js/tabs.js"></script>
  <script>
    var myTabs = tabs({
    el: '#tabs',
    tabNavigationLinks: '.c-tabs-nav__link',
    tabContentContainers: '.c-tab'
    });
    
    myTabs.init();
    //myTabs.goToTab(3);
  </script>

  <script src="ext/jquery/jquery-3.1.0.min.js"></script>-->
  <script src="ext/Trumbowyg-master/dist/trumbowyg.js"></script>
  <script>
    /** Default editor configuration **/
    $('#html_editor').trumbowyg();
  </script>

  <script src="ext/json-editor/jsoneditor.js"></script>
  <script src="ext/json-editor/initialise.js"></script>
  <script type="text/javascript">

function searchLexicon(search_term) {
    console.log("Searching lexicon for: " + search_term);

    var params = {
	"lexicons": "sv-se.nst",
	"words": search_term
    }
    
    $.get(
        'http://localhost/lexlookup',
        params,
        function(response) {
	    console.log(response);
	    entry_editor.setValue(response);
        }
    );

}

function wordInLex(word, div, trans) {
    console.log("Searching lexicon for: " + word);

    var known_words_container = document.getElementById("known_words_container");
    var unknown_words_container = document.getElementById("unknown_words_container");

    var params = {
	"lexicons": "sv-se.nst",
	"words": word
    }
    
    $.get(
        'http://localhost/lexlookup',
        params,
        function(response) {
	    console.log(response);
	    if ( response == null ) {
		console.log("Adding to unknown_words: "+word);
		var transcription = "NONE";
		trans.innerHTML = transcription;
		unknown_words_container.appendChild(div)
	    } else {
		console.log("Adding to known_words: "+word);

		var transcription = response[0].transcriptions[0].strn;
		//var transcription = "' A . p a";
		trans.innerHTML = transcription;

		known_words_container.appendChild(div)
	    }
        }
    );

}

function wordsInLex(sorted_wordlist) {
    var words = sorted_wordlist.join();
    console.log("Searching lexicon for: " + words);

    var known_words_container = document.getElementById("known_words_container");
    var unknown_words_container = document.getElementById("unknown_words_container");

    var params = {
	"lexicons": "sv-se.nst",
	"pagelength": 2*words.length,
	"words": words
    }
    
    $.get(
        'http://localhost/lexlookup',
        params,
        function(response) {
	    console.log(response);
	    for (i=0; i<sorted_wordlist.length; i += 1) {
		var div = document.getElementById("entry_"+i);
		var trans = document.getElementById("trans_"+i);
		for (j=0; j<response.length; j += 1) {
		    var found = false;
		    var word = sorted_wordlist[i];
		    if ( response[j].strn == word ) {
			console.log("Adding to known_words: "+word);

			//Replace transcription predicted by synthesiser with transcription from lexlookup (or leave it..)
			var transcription = response[j].transcriptions[0].strn;
			trans.innerHTML = transcription;

			known_words_container.appendChild(div);
			found = true;
		    }
		}
		if ( found = false ) {
		    console.log("Adding to unknown_words: "+word);
		    
		    var transcription = "NONE";
		    trans.innerHTML = transcription;
		    
		    unknown_words_container.appendChild(div)

		}
	    }
        }
    );

}


function tokeniseHtmlText() {
    var html_editor = document.getElementById('html_editor');
    console.log(html_editor);
    var html = html_editor.innerHTML;

    var ssml_header = '<?xml version="1.0" encoding="UTF-8" ?>\n<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis"\n  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n  xsi:schemaLocation="http://www.w3.org/2001/10/synthesis http://www.w3.org/TR/speech-synthesis/synthesis.xsd"\nxml:lang="sv">\n';
    var ssml_footer = "</speak>";

    var ssml_content = filterToSSML(html);
    
    var ssml = ssml_header+ssml_content+ssml_footer;
    
    console.log("Tokenising:\n"+ssml);

    var params = {
	"lang": "sv",
	"input_type": "ssml",
	"input": ssml
    }
    
    $.get(
        'http://localhost/wikispeech/textprocessing',
        params,
        function(response) {
	    console.log(response);

	    if (response.hasOwnProperty("paragraphs")) {
		console.log("Found utt");
		var data = getSentenceAndTokens(response);
		console.log(data.sentences);
		console.log(data.words);
		//addSentencesToSynthesisTab(data.sentences);
		addHtmlSentencesToSynthesisTab();
		addWordsToLexiconTab(data.words, data.transcriptions);
	    } else {
		console.log("ERROR: response is not an utt");
	    }
        }
    );
}

function filterToSSML(html) {
    //Because s and sub have html meanings, they are prefixed with "ssml:"
    var ssml_content = html.replace(/ssml:/g, "")

    //&nbsp; breaks marytts ssml parser.
    //Declare the entity?
    ssml_content = ssml_content.replace(/&nbsp;/g, " ")

    //remove unclosed br tags (even closed come out wrong)
    //ssml_content = ssml_content.replace(/<br>/g, "<br/>")
    ssml_content = ssml_content.replace(/<br>/g, " ")

    return ssml_content;
    
}

function getSentenceAndTokens(utt) {

    var sentencelist = [];
    var words = {};
    var transcriptions = {};
    
    var paragraphs = utt.paragraphs;
    for ( i=0; i<paragraphs.length; i++ ) {
	var p = paragraphs[i];
	var sentences = p.sentences;
	for ( j=0; j<sentences.length; j++ ) {
	    var s = sentences[j];
	    var phrases = s.phrases;
	    var tokenlist = [];
	    for ( l=0; l<phrases.length; l++ ) {
		var ph = phrases[l];
		var tokens = ph.tokens;
		for ( m=0; m<tokens.length; m++ ) {
		    var token = tokens[m];
		    //console.log(token);
		    var orth = token.token_orth;
		    orth = orth.toLowerCase();
		    tokenlist.push(orth);
		    if (orth in words) {
			words[orth] += 1;
		    } else {
			words[orth] = 1;
			var trans = getTranscription(token);
			transcriptions[orth] = trans;
		    }
		}
	    }
	    sentencelist.push({tokens:tokenlist});
	}
    }
    return {sentences:sentencelist, words: words, transcriptions: transcriptions};
}

function getTranscription(token) {
    var trans = "";
    var words = token.words;
    for ( i=0; i<words.length; i++ ) {
	var w = words[i];
	trans = trans+w.ph;
    }
    return trans;
}


function addHtmlSentencesToSynthesisTab() {
    var html_editor = document.getElementById('html_editor');
    console.log(html_editor);

    var synthesis_container = document.getElementById("synthesis_container");
    console.log(synthesis_container);
    synthesis_container.innerHTML = "";

    var text_chunks;

    //Use ssml:s tags if they exist
    text_chunks = html_editor.getElementsByTagName("ssml:s");
    //If there are no sentences, use p tags instead
    if ( text_chunks.length == 0 ) {
	text_chunks = html_editor.getElementsByTagName("p");
	//If there are no p tags, use entire text (?)
	if ( text_chunks.length == 0 ) {
	    text_chunks = [html_editor.innerHTML];
	}
    }


    console.log("TEXT CHUNKS: ");
    console.log(text_chunks);


    for ( i=0; i<text_chunks.length; i++ ) {
	var t = text_chunks[i];
	var clone = t.cloneNode(true);
	console.log("TEXT CHUNK: ");
	console.log(clone);
	
	var p = document.createElement("p");
	var speak = document.createElement("speak");

	//NOTE hardcoded language
	speak.setAttribute("xml:lang", "sv");
	
	speak.setAttribute("version","1.0");
	speak.setAttribute("xmlns", "http://www.w3.org/2001/10/synthesis");
	speak.setAttribute("xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");
	speak.setAttribute("xsi:schemalocation", "http://www.w3.org/2001/10/synthesis http://www.w3.org/TR/speech-synthesis/synthesis.xsd");

	p.appendChild(speak);

	var html = clone.innerHTML;
	console.log("HTML: "+html);
	var filtered = filterToSSML(html);
	console.log("Filtered: "+filtered);
	speak.innerHTML = filtered;
	
	synthesis_container.appendChild(p);

	p.setAttribute("class", "ssml");
	
	var id = "sentence_nr_"+i;
	p.setAttribute("id",id);

	var lang = "sv";
	p.setAttribute("lang", lang);
   
	var playButton = document.createElement("input");
	playButton.setAttribute("type", "button");
	playButton.setAttribute("value", "Speak");
	playButton.setAttribute("onclick", "play("+id+");");

	p.appendChild(playButton);

    }	    


}
    
function addSentencesToSynthesisTab(sentences) {
    var synthesis_container = document.getElementById("synthesis_container");
    console.log(synthesis_container);
    synthesis_container.innerHTML = "";

    for ( i=0; i<sentences.length; i++ ) {
	var s = sentences[i].tokens;
	var sentence_text = s.join(" ");

	var p = document.createElement("p");
	var t = document.createTextNode(sentence_text);
	p.appendChild(t);           
	synthesis_container.appendChild(p);
	
	var id = "sentence_nr_"+i;
	p.setAttribute("id",id);

	var lang = "sv";
	p.setAttribute("lang", lang);
   
	var playButton = document.createElement("input");
	playButton.setAttribute("type", "button");
	playButton.setAttribute("value", "Speak");
	playButton.setAttribute("onclick", "play("+id+");");

	p.appendChild(playButton);

    }	    
}

function addWordsToLexiconTab(words, transcriptions) {
    var known_words_container = document.getElementById("known_words_container");
    var unknown_words_container = document.getElementById("unknown_words_container");

    known_words_container.innerHTML = "";
    unknown_words_container.innerHTML = "";

    var sorted_wordlist = Object.keys(words).sort();
    //console.log(sorted_wordlist);

    for ( i=0; i<sorted_wordlist.length; i++ ) {
	var word = sorted_wordlist[i];
	if ( !word.match(/^[.,?!]+$/) ) {
	    //console.log("Adding word: "+word);

	    var word_id = "word_"+i;

	    //<div data-role="main" class="ui-content">
	    //<div class="ui-grid-a">
	    //<div class="ui-block-a">
					 
	    var div = document.createElement("div");
	    div.setAttribute("id","entry_"+i);
	    
	    var span = document.createElement("span");
	    span.setAttribute("id",word_id);
	    span.setAttribute("style", "display: inline-block; width: 10em;");
	    var w = document.createTextNode(word);
	    span.appendChild(w);
            div.appendChild(span);

	    //Add transcription predicted by synthesiser 
	    var trans = document.createElement("span");
	    trans.setAttribute("id","trans_"+i);
	    trans.setAttribute("style", "display: inline-block; width: 30em;");
	    trans.setAttribute("class", "ssml");
	    trans.setAttribute("lang", "sv");

	    var speak = document.createElement("speak");

	    //NOTE hardcoded language
	    speak.setAttribute("xml:lang", "sv");
	
	    speak.setAttribute("version","1.0");
	    speak.setAttribute("xmlns", "http://www.w3.org/2001/10/synthesis");
	    speak.setAttribute("xmlns:xsi", "http://www.w3.org/2001/XMLSchema-instance");
	    speak.setAttribute("xsi:schemalocation", "http://www.w3.org/2001/10/synthesis http://www.w3.org/TR/speech-synthesis/synthesis.xsd");

	    var transcription = transcriptions[word];
	    transcription = transcription.replace(/"/g, "&quot;");
	    var ssml = "<p><phoneme alphabet=\"x-sampa\" ph=\""+transcription+"\">"+transcription+"</phoneme></p>";
	    //var ssml = "<p><phoneme alphabet=\"x-sampa\" ph=\""+transcription+"\">BABIAN</phoneme></p>";
	    //var t = document.createTextNode(ssml);
	    //speak.appendChild(t);
	    speak.innerHTML = ssml;
	    trans.appendChild(speak);
	    div.appendChild(trans);
	    
	    var buttons = document.createElement("span");

	    var listen_button = document.createElement("input");
	    listen_button.setAttribute("type","button");
	    listen_button.setAttribute("value","listen");
	    listen_button.setAttribute("onclick", "play($('#trans_"+i+"')[0]);");
	    //listen_button.setAttribute("onclick", "playTranscription($('#trans_"+i+"'));");
	    buttons.appendChild(listen_button);
	    
	    var edit_button = document.createElement("input");
	    edit_button.setAttribute("type","button");
	    edit_button.setAttribute("value","edit");
	    edit_button.setAttribute("onclick", "myTabs.goToTab(3);searchLexicon($('#"+word_id+"')[0].innerHTML);");
	    buttons.appendChild(edit_button);

	    div.appendChild(buttons);
	    unknown_words_container.appendChild(div);


	} else {
	    console.log("Ignoring: "+word);
	}
    }
    wordsInLex(sorted_wordlist);


}


function playTranscription(t) {
    console.log(t);
    var trans = t[0].innerHTML;
    console.log(trans);
    alert("playTranscription "+trans+" not yet implemented");
}


//function wordInLex(word) {
//    return false;
//}

//HB not used but leaving it here anyway for now..
function findNodes(id, currentNode) {
    var i,
        currentChild,
        result;

    if (id == currentNode.id) {
        return currentNode;
    } else {

        // Use a for loop instead of forEach to avoid nested functions
        // Otherwise "return" will not work properly
        for (i = 0; i < currentNode.children.length; i += 1) {
            currentChild = currentNode.children[i];

            // Search in the current child
            result = findNode(id, currentChild);

            // Return the result if the node has been found
            if (result !== false) {
                return result;
            }
        }

        // The node has not been found and we have no more options
        return false;
    }
}
  </script>
  

</body>
</html>
