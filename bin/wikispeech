#!/usr/bin/env python3

import sys, traceback
sys.path.insert(0,".")
import wikispeech_mockup.wikispeech as ws
import wikispeech_mockup.config as config




ws.log.log_level = config.config.get("Server","log_level")

try:
    run_tests = config.config.getboolean("Tests","run_startup_tests")
except:
    run_tests = False
    
if run_tests:
    ws.log.info("RUNNING SELF-TESTS...")

    try:
        ws.test_config()        
        ws.test_wikilex()
        ws.test_textproc()
        ws.test_wikispeech()

        #These tests are run directly on import. TODO change to normal method invocation 
        import wikispeech_mockup.test_api
        import wikispeech_mockup.test_voice_configs
        import wikispeech_mockup.adapters.test_marytts_adapter
        ws.log.info("ALL SELF-TESTS RUN SUCCESSFULLY")

        
    except:
        print("Test error:\n%s\n%s" % (sys.exc_info()[0], sys.exc_info()[1]) )
        traceback.print_tb(sys.exc_info()[2])
        if config.config.getboolean("Tests","quit_on_error"):
            print("Exiting because of test error and Tests:quit_on_error is set to True")
            sys.exit()
        else:
            print("Starting anyway because Tests:quit_on_error is set to False")


        
ws.log.info("Loaded textprocessors: %s" % ws.textprocessors)
ws.log.info("Loaded textprocessors for languages: %s" % ws.textprocSupportedLanguages())

ws.log.info("Loaded voices: %s" % ws.voices)
ws.log.info("Loaded voices for languages: %s" % ws.synthesisSupportedLanguages())

ws.log.info("Supported languages: %s" % ws.getSupportedLanguages())

port_nr = config.config.get("Server","port")
 
ws.app.run(host='0.0.0.0', port=port_nr, debug=False, threaded=True)



